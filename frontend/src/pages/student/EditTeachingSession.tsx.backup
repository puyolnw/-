import React, { useState, useEffect } from 'react';
import { useNavigate, useParams } from 'react-router-dom';
import LoggedLayout from '../../components/layouts/LoggedLayout';
import { teachingSessionApiService, type TeachingSession } from '../../services/teachingSessionApi';
import { lessonPlanApiService } from '../../services/lessonPlanApi';

interface Subject {
  id: number;
  subject_code: string;
  subject_name: string;
}

interface LessonPlan {
  id: number;
  lesson_plan_name: string;
  subject_id: number;
  subject_name: string;
}

interface TimeSlot {
  id: string;
  label: string;
  startTime: string;
  endTime: string;
  isSelected: boolean;
}

const EditTeachingSession: React.FC = () => {
  const navigate = useNavigate();
  const { id } = useParams<{ id: string }>();
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [session, setSession] = useState<TeachingSession | null>(null);
  const [subjects, setSubjects] = useState<Subject[]>([]);
  const [lessonPlans, setLessonPlans] = useState<LessonPlan[]>([]);
  const [selectedSubject, setSelectedSubject] = useState<number | null>(null);
  const [selectedLessonPlan, setSelectedLessonPlan] = useState<number | null>(null);
  const [teachingDate, setTeachingDate] = useState<string>('');
  const [selectedTimeSlots, setSelectedTimeSlots] = useState<TimeSlot[]>([]);
  const [classLevel, setClassLevel] = useState<string>('');
  const [classRoom, setClassRoom] = useState<string>('');
  const [studentCount, setStudentCount] = useState<number | null>(null);
  const [lessonTopic, setLessonTopic] = useState<string>('');
  const [lessonSummary, setLessonSummary] = useState<string>('');
  const [learningOutcomes, setLearningOutcomes] = useState<string>('');
  const [teachingMethodsUsed, setTeachingMethodsUsed] = useState<string>('');
  const [materialsUsed, setMaterialsUsed] = useState<string>('');
  const [studentEngagement, setStudentEngagement] = useState<string>('');
  const [problemsEncountered, setProblemsEncountered] = useState<string>('');
  const [problemSolutions, setProblemSolutions] = useState<string>('');
  const [lessonsLearned, setLessonsLearned] = useState<string>('');
  const [reflection, setReflection] = useState<string>('');
  const [improvementNotes, setImprovementNotes] = useState<string>('');
  const [selfRating, setSelfRating] = useState<number | null>(null);
  const [sessionFiles, setSessionFiles] = useState<any[]>([]);
  const [newFiles, setNewFiles] = useState<File[]>([]);
  const [error, setError] = useState<string | null>(null);

  // Time slots configuration - moved outside component to avoid recreation
  const initialTimeSlots: TimeSlot[] = [
    { id: '08:00-09:00', label: '08:00 - 09:00', startTime: '08:00', endTime: '09:00', isSelected: false },
    { id: '09:00-10:00', label: '09:00 - 10:00', startTime: '09:00', endTime: '10:00', isSelected: false },
    { id: '10:00-11:00', label: '10:00 - 11:00', startTime: '10:00', endTime: '11:00', isSelected: false },
    { id: '11:00-12:00', label: '11:00 - 12:00', startTime: '11:00', endTime: '12:00', isSelected: false },
    { id: '12:00-13:00', label: '12:00 - 13:00', startTime: '12:00', endTime: '13:00', isSelected: false },
    { id: '13:00-14:00', label: '13:00 - 14:00', startTime: '13:00', endTime: '14:00', isSelected: false },
    { id: '14:00-15:00', label: '14:00 - 15:00', startTime: '14:00', endTime: '15:00', isSelected: false },
    { id: '15:00-16:00', label: '15:00 - 16:00', startTime: '15:00', endTime: '16:00', isSelected: false },
    { id: '16:00-17:00', label: '16:00 - 17:00', startTime: '16:00', endTime: '17:00', isSelected: false },
  ];

  useEffect(() => {
    if (id) {
      fetchSessionDetail();
      fetchSubjects();
    }
  }, [id]);

  useEffect(() => {
    if (selectedSubject) {
      fetchLessonPlans(selectedSubject);
    } else {
      setLessonPlans([]);
      setSelectedLessonPlan(null);
    }
  }, [selectedSubject]);

  const fetchSessionDetail = async () => {
    try {
      setLoading(true);
      const response = await teachingSessionApiService.getTeachingSessionById(Number(id));
      
      if (response.success && response.data) {
        const sessionData = response.data;
        setSession(sessionData);
        
        // Populate form with existing data
        setSelectedSubject(sessionData.subject_id);
        setSelectedLessonPlan(sessionData.lesson_plan_id);
        setTeachingDate(sessionData.teaching_date);
        setClassLevel(sessionData.class_level || '');
        setClassRoom(sessionData.class_room || '');
        setStudentCount(sessionData.student_count || null);
        setLessonTopic(sessionData.lesson_topic || '');
        setLessonSummary(sessionData.lesson_summary || '');
        setLearningOutcomes(sessionData.learning_outcomes || '');
        setTeachingMethodsUsed(sessionData.teaching_methods_used || '');
        setMaterialsUsed(sessionData.materials_used || '');
        setStudentEngagement(sessionData.student_engagement || '');
        setProblemsEncountered(sessionData.problems_encountered || '');
        setProblemSolutions(sessionData.problem_solutions || '');
        setLessonsLearned(sessionData.lessons_learned || '');
        setReflection(sessionData.reflection || '');
        setImprovementNotes(sessionData.improvement_notes || '');
        setSelfRating(sessionData.self_rating || null);
        
        // Set time slots based on existing time
        const startTime = sessionData.start_time.substring(0, 5);
        const endTime = sessionData.end_time.substring(0, 5);
        setSelectedTimeSlots(initialTimeSlots.map(slot => ({
          ...slot,
          isSelected: slot.startTime >= startTime && slot.endTime <= endTime
        })));
        
        // ใช้ข้อมูลไฟล์ที่ได้จาก response โดยตรง
        if (response.data.files) {
          setSessionFiles(response.data.files);
        } else {
          setSessionFiles([]);
        }
      } else {
        setError(response.message || 'ไม่สามารถโหลดข้อมูลได้');
      }
    } catch (error) {
      console.error('Error fetching session detail:', error);
      setError('เกิดข้อผิดพลาดในการโหลดข้อมูล');
    } finally {
      setLoading(false);
    }
  };

  const fetchSubjects = async () => {
    try {
      const response = await lessonPlanApiService.getSubjects({ limit: 100 });
      if (response.success && response.data) {
        setSubjects(response.data);
      }
    } catch (error) {
      console.error('Error fetching subjects:', error);
      setError('ไม่สามารถโหลดรายการวิชาได้');
    }
  };

  const fetchLessonPlans = async (subjectId: number) => {
    try {
      const response = await teachingSessionApiService.getAvailableLessonPlans(subjectId);
      if (response.success && response.data) {
        setLessonPlans(response.data);
      }
    } catch (error) {
      console.error('Error fetching lesson plans:', error);
      setError('ไม่สามารถโหลดรายการแผนการสอนได้');
    }
  };

  const handleTimeSlotClick = (slotId: string) => {
    setSelectedTimeSlots(prev => {
      const newSlots = prev.map(slot => ({ ...slot })); // Deep copy to avoid mutation
      const slotIndex = newSlots.findIndex(slot => slot.id === slotId);
      
      if (slotIndex === -1) return prev;
      
      const slot = newSlots[slotIndex];
      
      // If clicking on the first slot or a slot that's already selected, toggle it
      if (slotIndex === 0 || slot.isSelected) {
        slot.isSelected = !slot.isSelected;
      } else {
        // Check if previous slot is selected (consecutive selection)
        const prevSlot = newSlots[slotIndex - 1];
        if (prevSlot.isSelected) {
          slot.isSelected = !slot.isSelected;
        } else {
          // If previous slot is not selected, select from this slot onwards
          slot.isSelected = true;
        }
      }
      
      // If unselecting a slot, unselect all subsequent slots
      if (!slot.isSelected) {
        for (let i = slotIndex + 1; i < newSlots.length; i++) {
          newSlots[i].isSelected = false;
        }
      }
      
      return newSlots;
    });
  };

  const getSelectedTimeRange = () => {
    const selectedSlots = selectedTimeSlots.filter(slot => slot.isSelected);
    if (selectedSlots.length === 0) return null;
    
    const firstSlot = selectedSlots[0];
    const lastSlot = selectedSlots[selectedSlots.length - 1];
    
    return {
      startTime: firstSlot.startTime,
      endTime: lastSlot.endTime
    };
  };

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(event.target.files || []);
    setNewFiles(prev => [...prev, ...files]);
  };

  const removeNewFile = (index: number) => {
    setNewFiles(prev => prev.filter((_, i) => i !== index));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!selectedSubject || !selectedLessonPlan || !teachingDate) {
      setError('กรุณากรอกข้อมูลที่จำเป็น');
      return;
    }

    const timeRange = getSelectedTimeRange();
    if (!timeRange) {
      setError('กรุณาเลือกเวลาสอน');
      return;
    }

    try {
      setSubmitting(true);
      setError(null);

      const response = await teachingSessionApiService.updateTeachingSession(Number(id), {
        lesson_plan_id: selectedLessonPlan,
        subject_id: selectedSubject,
        teaching_date: teachingDate,
        start_time: timeRange.startTime,
        end_time: timeRange.endTime,
        class_level: classLevel || undefined,
        class_room: classRoom || undefined,
        student_count: studentCount || undefined,
        lesson_topic: lessonTopic || undefined,
        lesson_summary: lessonSummary || undefined,
        learning_outcomes: learningOutcomes || undefined,
        teaching_methods_used: teachingMethodsUsed || undefined,
        materials_used: materialsUsed || undefined,
        student_engagement: studentEngagement || undefined,
        problems_encountered: problemsEncountered || undefined,
        problem_solutions: problemSolutions || undefined,
        lessons_learned: lessonsLearned || undefined,
        reflection: reflection || undefined,
        improvement_notes: improvementNotes || undefined,
        self_rating: selfRating || undefined,
      });

      if (response.success) {
        // อัปโหลดไฟล์ใหม่ถ้ามี
        if (newFiles.length > 0) {
          try {
            const fileUploadResponse = await teachingSessionApiService.uploadFiles(Number(id), newFiles);
            if (!fileUploadResponse.success) {
              console.warn('Files upload failed:', fileUploadResponse.message);
            }
          } catch (fileError) {
            console.warn('Files upload error:', fileError);
          }
        }
        
        alert('บันทึกการแก้ไขสำเร็จ!');
        navigate(`/student/teaching-sessions/${id}`);
      } else {
        const errorMessage = response.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล';
        setError(errorMessage);
        alert(`ไม่สามารถบันทึกการแก้ไขได้: ${errorMessage}`);
      }
    } catch (error: any) {
      console.error('Error updating teaching session:', error);
      const errorMessage = error.response?.data?.message || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล';
      setError(errorMessage);
      alert(`ไม่สามารถบันทึกการแก้ไขได้: ${errorMessage}`);
    } finally {
      setSubmitting(false);
    }
  };

  if (loading) {
    return (
      <LoggedLayout currentPage="teaching-sessions">
        <div className="min-h-screen bg-gray-50 py-8">
          <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="bg-white shadow rounded-lg p-8">
              <div className="flex justify-center items-center">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <span className="ml-3 text-gray-600">กำลังโหลดข้อมูล...</span>
              </div>
            </div>
          </div>
        </div>
      </LoggedLayout>
    );
  }

  if (error && !session) {
    return (
      <LoggedLayout currentPage="teaching-sessions">
        <div className="min-h-screen bg-gray-50 py-8">
          <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div className="bg-white shadow rounded-lg p-8">
              <div className="text-center">
                <div className="text-red-600 mb-4">
                  <svg className="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                  </svg>
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">เกิดข้อผิดพลาด</h3>
                <p className="text-gray-600 mb-4">{error}</p>
                <button
                  onClick={() => navigate('/student/teaching-sessions')}
                  className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  กลับไปหน้ารายการ
                </button>
              </div>
            </div>
          </div>
        </div>
      </LoggedLayout>
    );
  }

  return (
    <LoggedLayout currentPage="teaching-sessions">
      <div className="min-h-screen bg-gray-50 py-8">
        <div className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="bg-white shadow rounded-lg">
            <div className="px-6 py-4 border-b border-gray-200">
              <h1 className="text-2xl font-bold text-gray-900">แก้ไขบันทึกการฝึกสอน</h1>
              <p className="mt-1 text-sm text-gray-600">แก้ไขข้อมูลการฝึกสอนของคุณ</p>
            </div>

            <form onSubmit={handleSubmit} className="p-6 space-y-8">
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-md p-4">
                  <div className="flex">
                    <div className="ml-3">
                      <h3 className="text-sm font-medium text-red-800">เกิดข้อผิดพลาด</h3>
                      <div className="mt-2 text-sm text-red-700">{error}</div>
                    </div>
                  </div>
                </div>
              )}

              {/* Basic Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    วันที่สอน <span className="text-red-500">*</span>
                  </label>
                  <input
                    type="date"
                    value={teachingDate}
                    onChange={(e) => setTeachingDate(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    วิชาที่สอน <span className="text-red-500">*</span>
                  </label>
                  <select
                    value={selectedSubject || ''}
                    onChange={(e) => setSelectedSubject(Number(e.target.value) || null)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
                  >
                    <option value="">เลือกวิชา</option>
                    {subjects.map((subject) => (
                      <option key={subject.id} value={subject.id}>
                        {subject.subject_code} - {subject.subject_name}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  แผนการสอนประจำคาบนี้ <span className="text-red-500">*</span>
                </label>
                <select
                  value={selectedLessonPlan || ''}
                  onChange={(e) => setSelectedLessonPlan(Number(e.target.value) || null)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                  disabled={!selectedSubject}
                >
                  <option value="">เลือกแผนการสอน</option>
                  {lessonPlans.map((plan) => (
                    <option key={plan.id} value={plan.id}>
                      {plan.lesson_plan_name}
                    </option>
                  ))}
                </select>
              </div>

              {/* Time Slots Selection */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-4">
                  เลือกคาบเรียนที่เข้าไปสอน <span className="text-red-500">*</span>
                </label>
                <div className="grid grid-cols-3 md:grid-cols-5 gap-3">
                  {selectedTimeSlots.map((slot) => (
                    <button
                      key={slot.id}
                      type="button"
                      onClick={() => handleTimeSlotClick(slot.id)}
                      className={`p-4 rounded-lg border-2 transition-all duration-200 ${
                        slot.isSelected
                          ? 'border-blue-500 bg-blue-50 text-blue-700 shadow-md transform scale-105'
                          : 'border-gray-300 bg-white text-gray-700 hover:border-gray-400 hover:bg-gray-50'
                      }`}
                    >
                      <div className="text-sm font-medium">{slot.label}</div>
                    </button>
                  ))}
                </div>
                <p className="mt-2 text-sm text-gray-600">
                  คลิกเพื่อเลือกคาบเรียน (สามารถเลือกหลายคาบติดต่อกันได้)
                </p>
              </div>

              {/* Class Information */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ระดับชั้น
                  </label>
                  <input
                    type="text"
                    value={classLevel}
                    onChange={(e) => setClassLevel(e.target.value)}
                    placeholder="เช่น ม.1, ป.3"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ห้องเรียน
                  </label>
                  <input
                    type="text"
                    value={classRoom}
                    onChange={(e) => setClassRoom(e.target.value)}
                    placeholder="เช่น ห้อง 101"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    จำนวนนักเรียน
                  </label>
                  <input
                    type="number"
                    value={studentCount || ''}
                    onChange={(e) => setStudentCount(Number(e.target.value) || null)}
                    placeholder="เช่น 30"
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>

              {/* Lesson Details */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  หัวข้อบทเรียน
                </label>
                <input
                  type="text"
                  value={lessonTopic}
                  onChange={(e) => setLessonTopic(e.target.value)}
                  placeholder="หัวข้อที่สอนในคาบนี้"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  สรุปบทเรียน
                </label>
                <textarea
                  value={lessonSummary}
                  onChange={(e) => setLessonSummary(e.target.value)}
                  rows={3}
                  placeholder="สรุปเนื้อหาที่สอนในคาบนี้"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ผลการเรียนรู้
                </label>
                <textarea
                  value={learningOutcomes}
                  onChange={(e) => setLearningOutcomes(e.target.value)}
                  rows={3}
                  placeholder="สิ่งที่นักเรียนควรจะเรียนรู้ได้หลังจากจบคาบนี้"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  วิธีการสอนที่ใช้
                </label>
                <textarea
                  value={teachingMethodsUsed}
                  onChange={(e) => setTeachingMethodsUsed(e.target.value)}
                  rows={3}
                  placeholder="เช่น การบรรยาย, การอภิปราย, การทำกิจกรรม"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  สื่อการสอนที่ใช้
                </label>
                <textarea
                  value={materialsUsed}
                  onChange={(e) => setMaterialsUsed(e.target.value)}
                  rows={3}
                  placeholder="เช่น หนังสือ, สไลด์, กระดาน, อุปกรณ์"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              {/* Reflection Section */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  การมีส่วนร่วมของนักเรียน
                </label>
                <textarea
                  value={studentEngagement}
                  onChange={(e) => setStudentEngagement(e.target.value)}
                  rows={3}
                  placeholder="นักเรียนมีส่วนร่วมในการเรียนอย่างไร"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ปัญหาที่เกิดขึ้น
                </label>
                <textarea
                  value={problemsEncountered}
                  onChange={(e) => setProblemsEncountered(e.target.value)}
                  rows={3}
                  placeholder="ปัญหาหรืออุปสรรคที่พบในการสอน"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  วิธีแก้ปัญหา
                </label>
                <textarea
                  value={problemSolutions}
                  onChange={(e) => setProblemSolutions(e.target.value)}
                  rows={3}
                  placeholder="วิธีการแก้ไขปัญหาที่เกิดขึ้น"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  สิ่งที่ได้เรียนรู้
                </label>
                <textarea
                  value={lessonsLearned}
                  onChange={(e) => setLessonsLearned(e.target.value)}
                  rows={3}
                  placeholder="สิ่งที่คุณได้เรียนรู้จากการสอนครั้งนี้"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  การสะท้อนคิด
                </label>
                <textarea
                  value={reflection}
                  onChange={(e) => setReflection(e.target.value)}
                  rows={3}
                  placeholder="การสะท้อนคิดเกี่ยวกับการสอนครั้งนี้"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  ข้อเสนอแนะในการปรับปรุง
                </label>
                <textarea
                  value={improvementNotes}
                  onChange={(e) => setImprovementNotes(e.target.value)}
                  rows={3}
                  placeholder="ข้อเสนอแนะสำหรับการปรับปรุงการสอนในครั้งต่อไป"
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  การให้คะแนนตนเอง (1-5)
                </label>
                <select
                  value={selfRating || ''}
                  onChange={(e) => setSelfRating(Number(e.target.value) || null)}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">เลือกคะแนน</option>
                  <option value="1">1 - ต้องปรับปรุงมาก</option>
                  <option value="2">2 - ต้องปรับปรุง</option>
                  <option value="3">3 - พอใช้</option>
                  <option value="4">4 - ดี</option>
                  <option value="5">5 - ดีมาก</option>
                </select>
              </div>

              {/* Files Section */}
              {sessionFiles.length > 0 && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-4">
                    ไฟล์ที่แนบมา
                  </label>
                  <div className="space-y-3">
                    {sessionFiles.map((file) => (
                      <div key={file.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex items-center space-x-3">
                          <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            {file.file_category === 'photo' ? (
                              <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                              </svg>
                            ) : file.file_category === 'video' ? (
                              <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                              </svg>
                            ) : (
                              <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                            )}
                          </div>
                          <div>
                            <p className="text-sm font-medium text-gray-900">{file.file_name}</p>
                            <p className="text-xs text-gray-500">
                              {file.file_category === 'photo' ? 'รูปภาพ' : 
                               file.file_category === 'video' ? 'วิดีโอ' : 
                               file.file_category === 'document' ? 'เอกสาร' : 'ไฟล์อื่นๆ'}
                              • {Math.round(file.file_size / 1024)} KB
                            </p>
                          </div>
                        </div>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => {
                              // ดาวน์โหลดไฟล์
                              const link = document.createElement('a');
                              link.href = `/api/student/teaching-sessions/${id}/files/${file.id}/download`;
                              link.download = file.file_name;
                              link.click();
                            }}
                            className="text-blue-600 hover:text-blue-800 text-sm"
                          >
                            ดาวน์โหลด
                          </button>
                          <button
                            onClick={async () => {
                              if (window.confirm('คุณแน่ใจหรือไม่ที่จะลบไฟล์นี้?')) {
                                try {
                                  const response = await teachingSessionApiService.deleteFile(Number(id), file.id);
                                  if (response.success) {
                                    setSessionFiles(prev => prev.filter(f => f.id !== file.id));
                                    alert('ลบไฟล์สำเร็จ!');
                                  } else {
                                    alert('ไม่สามารถลบไฟล์ได้');
                                  }
                                } catch (error) {
                                  console.error('Error deleting file:', error);
                                  alert('เกิดข้อผิดพลาดในการลบไฟล์');
                                }
                              }
                            }}
                            className="text-red-600 hover:text-red-800 text-sm"
                          >
                            ลบ
                          </button>
                        </div>
                      </div>
                      
                      {/* แสดงรูปภาพถ้าเป็นไฟล์รูป */}
                      {file.file_category === 'photo' && (
                        <div className="mt-3">
                          <img
                            src={`/api/uploads/teaching-sessions/${file.file_path.split('/').pop()}`}
                            alt={file.file_name}
                            className="max-w-full h-auto rounded-lg shadow-md border border-gray-200"
                            style={{ maxHeight: '300px' }}
                            onError={(e) => {
                              console.error('Error loading image:', e);
                              e.currentTarget.style.display = 'none';
                            }}
                          />
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {/* Upload New Files */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  อัปโหลดไฟล์เพิ่มเติม
                </label>
                <input
                  type="file"
                  multiple
                  onChange={handleFileUpload}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                  accept="image/*,video/*,.pdf,.doc,.docx"
                />
                <p className="mt-1 text-sm text-gray-500">
                  รองรับไฟล์รูปภาพ, วิดีโอ, PDF, Word (สูงสุด 20MB ต่อไฟล์)
                </p>
                
                {/* แสดงไฟล์ที่เลือกใหม่ */}
                {newFiles.length > 0 && (
                  <div className="mt-4 space-y-2">
                    <h4 className="text-sm font-medium text-gray-700">ไฟล์ที่จะอัปโหลด:</h4>
                    {newFiles.map((file, index) => (
                      <div key={index} className="flex items-center justify-between p-2 bg-blue-50 rounded-lg">
                        <span className="text-sm text-gray-700">{file.name}</span>
                        <button
                          type="button"
                          onClick={() => removeNewFile(index)}
                          className="text-red-600 hover:text-red-800 text-sm"
                        >
                          ลบ
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Submit Buttons */}
              <div className="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                <button
                  type="button"
                  onClick={() => navigate(`/student/teaching-sessions/${id}`)}
                  className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500"
                >
                  ยกเลิก
                </button>
                <button
                  type="submit"
                  disabled={submitting}
                  className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {submitting ? 'กำลังบันทึก...' : 'บันทึกการแก้ไข'}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </LoggedLayout>
  );
};

export default EditTeachingSession;
